From 0f64ff48d9ef701cb7f88ccf1319c0e22b078bbc Mon Sep 17 00:00:00 2001
From: a1ive <10670106+a1ive@users.noreply.github.com>
Date: Tue, 17 Nov 2020 03:49:19 +0800
Subject: [PATCH] mb2

---
 grub-core/kern/i386/multiboot/startup.S | 102 +++++++++++++++++++-----
 include/multiboot2.h                    |   1 +
 2 files changed, 82 insertions(+), 21 deletions(-)

diff --git a/grub-core/kern/i386/multiboot/startup.S b/grub-core/kern/i386/multiboot/startup.S
index cdfcd91d7..d1923678b 100644
--- a/grub-core/kern/i386/multiboot/startup.S
+++ b/grub-core/kern/i386/multiboot/startup.S
@@ -1,6 +1,6 @@
 /*
  *  GRUB  --  GRand Unified Bootloader
- *  Copyright (C) 1999,2000,2001,2002,2003,2005,2006,2007,2008 Free Software Foundation, Inc.
+ *  Copyright (C) 2020 Free Software Foundation, Inc.
  *
  *  GRUB is free software: you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -20,7 +20,6 @@
 #include <grub/machine/memory.h>
 #include <grub/cpu/linux.h>
 #include <grub/offsets.h>
-#include <multiboot.h>
 #include <multiboot2.h>
 
 /*
@@ -35,8 +34,9 @@
     .text
     .globl   start, _start
 start:
+efi32_start:
 _start:
-    cmpl    $MULTIBOOT_BOOTLOADER_MAGIC, %eax
+    cmpl    $MULTIBOOT2_BOOTLOADER_MAGIC, %eax
     jne     0f
     movl    %ebx, EXT_C(kern_multiboot_info)
 0:
@@ -47,29 +47,89 @@ _start:
     /* jump to the main body of C code */
     jmp   EXT_C(grub_main)
 
+efi64_start:
+    movl    %eax, LOCAL(mb2_eax)
+    movl    %ebx, LOCAL(mb2_ebx)
+    /* disable paging */
+    movl    %cr0, %eax
+    andl    $(~GRUB_MEMORY_CPU_CR0_PAGING_ON), %eax
+    movl    %eax, %cr0
+    /* Disable amd64. */
+    movl    $GRUB_MEMORY_CPU_AMD64_MSR, %ecx
+    rdmsr
+    andl    $(~GRUB_MEMORY_CPU_AMD64_MSR_ON), %eax
+    wrmsr
+    /* Turn off PAE. */
+    movl    %cr4, %eax
+    andl    $(~GRUB_MEMORY_CPU_CR4_PAE_ON), %eax
+    movl    %eax, %cr4
+    /* movl imm32, %eax*/
+    .byte   0x66, 0xb8
+LOCAL(mb2_eax):
+    .long   0
+    /* mov imm32, %ebx */
+    .byte   0xbb
+LOCAL(mb2_ebx):
+    .long   0
+    jmp     start
+
 /*
- *  Support for booting GRUB from a Multiboot boot loader (e.g. GRUB itself).
+ *  Support for booting GRUB from a Multiboot2 boot loader (e.g. GRUB itself).
  */
-#define MULTIBOOT_FLAGS (MULTIBOOT_MEMORY_INFO | \
-                         MULTIBOOT_VIDEO_MODE)
-    .p2align  2 /* force 4-byte alignment */
-multiboot_header:
+#define MULTIBOOT2_ARCH MULTIBOOT2_ARCHITECTURE_I386
+    .align  8 /* force 8-byte alignment */
+mb2_hdr:
     /* magic */
-    .long   MULTIBOOT_HEADER_MAGIC
-    /* flags */
-    .long   MULTIBOOT_FLAGS
+    .long   MULTIBOOT2_HEADER_MAGIC
+    /* architecture */
+    .long   MULTIBOOT2_ARCH
+    /* header length */
+    .long   mb2_hdr_end - mb2_hdr
     /* checksum */
-    .long   -(MULTIBOOT_HEADER_MAGIC+MULTIBOOT_FLAGS) /* checksum */
-    .long   0
+    .long   -(MULTIBOOT2_HEADER_MAGIC + MULTIBOOT2_ARCH + (mb2_hdr_end - mb2_hdr))
+    .align  8
+fb_tag_start:
+    .short  MULTIBOOT_HEADER_TAG_FRAMEBUFFER
+    .short  MULTIBOOT_HEADER_TAG_OPTIONAL
+    .long   fb_tag_end - fb_tag_start
+    .long   1024
+    .long   768
+    .long   32
+fb_tag_end:
+    .align  8
+bs_tag_start:
+    .short  MULTIBOOT_HEADER_TAG_EFI_BS
+    .short  MULTIBOOT_HEADER_TAG_OPTIONAL
+    .long   bs_tag_end - bs_tag_start
+bs_tag_end:
+    .align  8
+console_tag_start:
+    .short  MULTIBOOT_HEADER_TAG_CONSOLE_FLAGS
+    .short  0
+    .long   console_tag_end - console_tag_start
     .long   0
-    .long   0
-    .long   0
-    .long   0
-
-    .long   1 /* mode_type */
-    .long   1024 /* cols */
-    .long   768 /* rows */
-    .long   0 /* color depth */
+console_tag_end:
+    .align  8
+efi64_tag_start:
+    .short  MULTIBOOT_HEADER_TAG_ENTRY_ADDRESS_EFI64
+    .short  MULTIBOOT_HEADER_TAG_OPTIONAL
+    .long efi64_tag_end - efi64_tag_start
+    .long   efi64_start
+efi64_tag_end:
+    .align  8
+efi32_tag_start:
+    .short  MULTIBOOT_HEADER_TAG_ENTRY_ADDRESS_EFI32
+    .short  MULTIBOOT_HEADER_TAG_OPTIONAL
+    .long efi32_tag_end - efi32_tag_start
+    .long   efi32_start
+efi32_tag_end:
+    .align  8
+tag_end:
+    .word   0
+    .word   0
+    .long   8
+tag_end_end:
+mb2_hdr_end:
 
 #include "../realmode.S"
 #include "../int.S"
diff --git a/include/multiboot2.h b/include/multiboot2.h
index 5693923c0..a8f7fbadf 100644
--- a/include/multiboot2.h
+++ b/include/multiboot2.h
@@ -72,6 +72,7 @@
 #define MULTIBOOT_HEADER_TAG_FRAMEBUFFER  5
 #define MULTIBOOT_HEADER_TAG_MODULE_ALIGN  6
 #define MULTIBOOT_HEADER_TAG_EFI_BS  7
+#define MULTIBOOT_HEADER_TAG_ENTRY_ADDRESS_EFI32  8
 #define MULTIBOOT_HEADER_TAG_ENTRY_ADDRESS_EFI64  9
 #define MULTIBOOT_HEADER_TAG_RELOCATABLE  10
 
-- 
2.29.2

